
##交易流程

 * ####用户交易操作 下单逻辑流程


 1. 提交数据验证，验证成功；
 2. MYSQL操作：
    1. 保存提交交易信息至交易记录数据表，得到**交易ID**，
     2. 从用户账户操作交易金额，
        1. 添加冻结资金
        2. 减少可用资金；
  3. Redis操作：
     1. 有止损止盈
        1. 止损表添加`交易ID`   `止损价格`
        2. 止盈表添加`交易ID`  `止盈价格`
     2. 无止损
        1.以爆仓价格为止损价格，在止损表添加 `交易ID` `止损价格`
 * ####用户交易操作   平仓逻辑流程
  1. 根据交易单号，从Redis取出交易信息；
  2. 删除交易单中的止损止盈信息；
  3. 修改交易单号状态为关闭（订单已结束2）；
  4. 关闭类型修改为人为关闭，更新关闭时间、关闭价格（当前价格）；
  5. 删除Redis中transaction中交易单号信息；
  6. 解冻资金，还原可用资金，计算盈亏，将盈亏记入资金流水，修改资金总额、可用资金
  7. 修改Redis中user信息：资金总额，冻结资金，可用资金
  8. 发微信给用户，告知用户订单关闭信息；
 * ####守护进程及时止损止盈操作
 1. 买涨
    1. 止损
        1. `js`取出>=当前价格的所有单号
            1. 取出止损表中交易单号
            2. 取出交易表中交易单号对应的交易信息
            3. 修改交易表中交易信息(关闭价格，关闭时间，关闭类型)
            4. 删除止损和止盈表中交易单号对应的止损止盈信息
            5. 将交易单号写入队列，等待PHP执行
        2. `php`对于修改单号的状态为关闭，修改关闭价格为当前价格，解冻资金，还原可用资金，计算盈亏，将盈亏记入资金流水，修改资金总额、可用资金
    2. 止盈 
        1. 取出<=当前价格的所有单号
        2. 对于修改单号的状态为关闭，修改关闭价格为当前价格，解冻资金，还原可用资金，计算盈亏，将盈亏记入资金流水，修改资金总额、可用资金
 2. 买跌
 3. 发微信给用户，告知用户订单触发止损止盈关闭；
 
##REDIS数据结构

* 用户个人信息：
    * 类型: hash
    * key结构: user:(user_id)
    * 示例：user:123

   |key      |value | 备注 |
   |------   | ----  | ----|
   |amount  |账户总金额|
   |freezing_funds  | 冻结资金 |
   |available_funds |可用资金|
   
 * 交易信息表：
    * 类型：hash
    * key结构：transaction
    * 示例：transaction
    
    |key      |value | 备注 |
    |------   | ----  | ----|
    |交易ID   |交易全部信息|对应MYSQL中交易表中对应交易ID的一条记录全部内容转JSON后存储
   
* 交易品种涨跌止损：
    * 类型: zset
    * key结构: (交易品种):loss:(1/2)
    * 示例：
    
            sliver:loss:1  白银上涨止损
            crude:loss:2   原油下跌止损

   |score      |value | 备注 |
   |------   | ----  | ----|
   |价格  |交易ID|交易ID单号对应的止损价格|
   
* 交易品种涨跌止盈：
    * 类型: zset
    * key结构: (交易品种):profit:(1/2)
    * 示例：
    
            sliver:profit:1  白银上涨止盈
            crude:profit:2   原油下跌止盈

   |score      |value | 备注 |
   |------   | ----  | ----|
   |价格  |交易ID|交易ID单号对应的止盈价格|
    
* 交易品种最新价格：
    * 类型: hash
    * key结构: (交易品种):last
    * 示例：
    
            sliver:last  白银最新价格
            crude:last   原油最新价格

   |key      |value | 备注 |
   |------   | ----  | ----|
   | open | 开盘价| |
   | close | 收盘价| |
   | high | 最高价| |
   | low | 最低价| |
   | volume | 交易量| |
   | date | 日期时间|  格式 ：2016-08-02 13:38:59|
   | change | 变动差价| 和最后一次比较变动差价|
    
* 交易品种真实时间区间：
    * 类型: zset
    * key结构: (交易品种):realTime:(时间区间 H1/M15/M5/M/now):zset
    * 示例：
    
            sliver:realTime:H1:zset  白银小时区间
            sliver:realTime:M15:zset  白银15分钟区间
            sliver:realTime:M5:zset  白银5分钟区间
            sliver:realTime:M:zset  白银1分钟区间
            sliver:realTime:now:zset  白银秒区间
            

   |score      |value | 备注 |
   |------   | ----  | ----|
   |时间戳   |对应的时间格式 | 例： H1 2016-08-02 10|
      
      
* 交易品种真实时间区间价格信息：
    * 类型: hash
    * key结构: (交易品种):realTime:(时间区间 H1/M15/M5/M/now)
    * 示例：
    
            sliver:realTime:H1  白银小时区间价格信息
            sliver:realTime:M15  白银15分钟区间价格信息
            sliver:realTime:M5  白银5分钟区间价格信息
            sliver:realTime:M  白银1分钟区间价格信息
            sliver:realTime:now  白银1分钟区间价格信息

   |key      |value | 备注 |
   |------   | ----  | ----|
   | 时间区间 |价格信息集合|key对应时间区间  ,value为时间区间价格信息组合的字符串 |
    